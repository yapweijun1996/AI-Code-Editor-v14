<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Intelligent Code Editor</title>
    <script>
     (function() {
       const theme = localStorage.getItem('theme') || 'dark';
       document.documentElement.setAttribute('data-theme', theme);
     })();
    </script>
    <link rel="stylesheet" href="style.css" />
    <!-- jsTree CSS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css"
    />
    <!-- Isomorphic Git -->
    <script src="https://unpkg.com/isomorphic-git@1.25.3/index.umd.js"></script>
    <script src="https://unpkg.com/isomorphic-git@1.25.3/http/web/index.umd.js"></script>
  </head>
  <body>
    <div id="error-container"></div>
    <div class="container" id="split-container">
      <div id="file-tree-container" class="sidebar">
        <div class="sidebar-tabs">
            <div class="sidebar-tab active" id="files-tab">Files</div>
            <div class="sidebar-tab" id="git-tab">Git</div>
            <div class="sidebar-tab" id="search-tab">Search</div>
            <div class="sidebar-tab" id="tasks-tab">Tasks</div>
        </div>
        <div class="sidebar-content" id="files-content">
            <h2 style="margin: 0px 0px 5px 0px;">Project Files</h2>
            <div id="directory-controls">
              <button id="open-directory-button">Open Folder</button>
              <button id="reconnect-button" style="display: none;">Reconnect</button>
              <button id="forget-folder-button" style="display: none;">Forget Folder</button>
            </div>
            <div id="file-tree"></div>
        </div>
        <div class="sidebar-content" id="git-content" style="display: none;">
            <h3>Git Status</h3>
            <div id="git-status-container"></div>
            <h3>Commit</h3>
            <textarea id="commit-message" placeholder="Commit message"></textarea>
            <button id="commit-button">Commit</button>
        </div>
        <div class="sidebar-content" id="search-content" style="display: none;">
            <h3>Search in Files</h3>
            <input type="text" id="search-input" placeholder="Search">
            <div class="search-options">
                <label><input type="checkbox" id="search-regex"> Regex</label>
                <label><input type="checkbox" id="search-case-sensitive"> Case Sensitive</label>
            </div>
            <button id="search-button">Search</button>
            <div id="search-results-container"></div>
        </div>
        <div class="sidebar-content" id="tasks-content" style="display: none;">
            <h3>Tasks</h3>
            <div id="tasks-container"></div>
            <div id="task-output-container">
                <h4>Output</h4>
                <pre id="task-output"></pre>
            </div>
        </div>
    </div>
      <div id="editor-container" class="main-content">
        <div id="tab-bar"></div>
        <div id="editor"></div>
      </div>
      <div id="chat-panel" class="sidebar">
        <div class="chat-header">
          <h2>AI Chat</h2>
          <div class="toolbar-group" id="token-usage-display" style="display: flex;">
            <span id="token-request">Req: 3333</span>
            <span id="token-response">Res: 2241</span>
            <span id="token-total">Total: 5574</span>
          </div>
        </div>
        <div id="chat-messages"></div>
        <div id="chat-input-container">
          <div id="chat-toolbar">
            <div class="toolbar-group">
              <select id="model-selector" title="Select AI Model">
                <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                <option value="gemma-3-27b-it">Gemma 3 27B</option>
              </select>
              <select id="agent-mode-selector" title="Select Agent Mode">
                <option value="code" selected>Code</option>
                <option value="plan">GenAI Search</option>
              </select>
            </div>
            <div class="toolbar-group">
              <div class="dropdown">
                <button class="dropdown-button">Context</button>
                <div class="dropdown-content">
                  <button id="view-context-button">View Context</button>
                  <button id="condense-context-button">Condense Context</button>
                  <button id="clear-context-button">Clear Context</button>
                  <button id="view-tool-logs-button">View Tool Logs</button>
                </div>
              </div>
              <button id="format-button">Format Document</button>
              <button id="fix-errors-button">Fix Errors</button>
              <button id="view-checkpoints-button">Checkpoints</button>
              <button id="custom-rules-button">Custom Rules</button>
              <button id="toggle-files-button">Toggle Files</button>
              <button id="undo-last-change-button" title="Undo Last File Change">Undo</button>
            </div>
          </div>
          <div id="image-preview-container" style="display: none"></div>
          <textarea
            id="chat-input"
            placeholder="Type your message..."
          ></textarea>
          <div id="chat-actions">
            <input
              type="file"
              id="image-input"
              accept="image/*"
              style="display: none"
            />
            <button id="image-upload-button">ðŸ“Ž</button>
            <button id="chat-send-button">Send</button>
            <button id="chat-cancel-button" style="display: none">
              Cancel
            </button>
            <div id="thinking-indicator" style="display: none"></div>
          </div>
        </div>
        <details id="chat-settings">
          <summary>API Key Settings</summary>
          <p>
            Enter one or more Gemini API keys, separated by new lines. They will
            be stored locally and rotated automatically if one fails.
          </p>
          <textarea
            id="api-keys-textarea"
            placeholder="Enter API keys here..."
          ></textarea>
          <div id="rate-limiter-setting">
            <label for="rate-limit-slider">Request Delay (seconds):</label>
            <input type="range" id="rate-limit-slider" min="0" max="300" value="5" />
            <input type="number" id="rate-limit-input" min="0" max="300" value="5" />
          </div>
          <button id="save-keys-button">Save Keys</button>
          <button id="theme-toggle-button">ðŸŒ“</button>
                 </details>
               </div>
             </div>

    <div id="context-modal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Current Conversation Context</h2>
        <pre id="context-display"></pre>
      </div>
    </div>

    <div id="checkpoints-modal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Project Checkpoints</h2>
        <div class="checkpoint-controls">
            <button id="create-checkpoint-button">Create New</button>
            <button id="delete-selected-checkpoints-button" disabled>Delete Selected</button>
            <label>
                <input type="checkbox" id="select-all-checkpoints-checkbox" />
                Select All
            </label>
        </div>
        <div id="checkpoints-list-container">
          <table id="checkpoints-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all-checkpoints-checkbox-header" /></th>
                <th>Name</th>
                <th>File Path</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="checkpoints-list"></tbody>
          </table>
        </div>
        <div id="indexeddb-usage" class="storage-usage-info" style="margin-top: 12px; text-align: right; font-size: 0.95em; color: var(--text-secondary);">
          Loading storage usageâ€¦
        </div>
      </div>
    </div>

    <div id="custom-rules-modal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Custom Rules for <span id="custom-rules-mode-name"></span> Mode</h2>
        <p>These rules will be added to the system prompt for the selected AI mode.</p>
        <textarea id="custom-rules-textarea" placeholder="Enter custom rules here..."></textarea>
        <button id="save-custom-rules-button">Save Rules</button>
      </div>
    </div>

    <div id="tool-logs-modal" class="modal" style="display: none">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2>Tool Execution History</h2>
        <div id="tool-logs-list"></div>
      </div>
    </div>

    <!-- Load diff.js before Monaco loader to ensure Diff is globally available -->
    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
    <script src="js/lib/diff_match_patch.js"></script>
    <!-- Monaco Editor Loader -->
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="js/vendor/split.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.8/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/acorn@8.12.1/dist/acorn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/acorn-walk@8.3.2/dist/walk.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.min.js"></script>
    <!-- jQuery and jsTree -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <script>
      mermaid.initialize({ startOnLoad: false, theme: 'dark' });
    </script>
    <script type="module">
      import { GoogleGenerativeAI } from 'https://esm.run/@google/generative-ai';
      window.GoogleGenerativeAI = GoogleGenerativeAI;
    </script>
    <script src="js/tool_logger.js"></script>
    <script src="js/undo_manager.js"></script>
    <script type="module" src="js/main.js"></script>
  </body>
</html>
